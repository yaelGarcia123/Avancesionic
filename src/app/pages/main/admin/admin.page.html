<app-headeradmin title="ADMINISTRADOR"></app-headeradmin>

<ion-content>
  <div class="admin-layout">
    <!-- ===== Sidebar ===== -->
    <div class="sidebar">
      <h3>Panel</h3>
      <ul>
        <li
          [class.active]="selectedSection === 'users'"
          (click)="selectedSection = 'users'"
        >
          <ion-icon name="people-outline"></ion-icon>
          Usuarios y Casas
        </li>

        <li
          [class.active]="selectedSection === 'messages'"
          (click)="selectedSection = 'messages'"
        >
          <ion-icon name="chatbubble-ellipses-outline"></ion-icon>
          Mensajes
        </li>

        <li
  [class.active]="selectedSection === 'tickets'"
  (click)="setSection('tickets')"
>
  <ion-icon name="receipt-outline"></ion-icon>
  Tickets
</li>

      </ul>
    </div>

    <!-- ===== Main Content ===== -->
    <div class="main-content">
      <!-- üè† Secci√≥n: Usuarios y Casas -->
      <div *ngIf="selectedSection === 'users'" class="content-wrapper">
        <h1 class="section-title">Usuarios y Casas</h1>

        <!-- Botones de acci√≥n -->
        <div class="action-buttons">
          <ion-button
            class="action-btn"
            color="primary"
            (click)="loadAllData()"
          >
            <ion-icon name="refresh" slot="start"></ion-icon>
            Refresh Data
          </ion-button>

          <ion-button class="action-btn" color="success">
            <ion-icon name="download" slot="start"></ion-icon>
            Export Data
          </ion-button>

          <ion-button class="action-btn" color="primary" (click)="addHouse()">
            <ion-icon name="home" slot="start"></ion-icon>
            Places
          </ion-button>
        </div>

        <!-- Barra de b√∫squeda -->

        <div class="modern-searchbar-wide">
          <ion-icon name="search-outline" class="search-icon"></ion-icon>
          <input
            type="text"
            [(ngModel)]="searchTerm"
            (input)="filterData()"
            placeholder="Buscar usuario o casa..."
          />

          <ion-icon
            *ngIf="searchTerm"
            name="close-circle"
            class="clear-icon"
            (click)="searchTerm = ''; filterData()"
          ></ion-icon>
        </div>

        <!-- Estad√≠sticas r√°pidas -->
        <div class="stats-container">
          <div class="stat-card primary">
            <ion-icon name="people-outline" class="stat-icon"></ion-icon>
            <h2>{{ filteredUsers.length }}</h2>
            <p>Total Usuarios</p>
          </div>

          <div class="stat-card secondary">
            <ion-icon name="home-outline" class="stat-icon"></ion-icon>
            <h2>{{ totalHouses }}</h2>
            <p>Casas Registradas</p>
          </div>

          <div class="stat-card tertiary">
            <ion-icon
              name="checkmark-circle-outline"
              class="stat-icon"
            ></ion-icon>
            <h2>{{ activeHouses }}</h2>
            <p>Casas Activas</p>
          </div>
        </div>

        <!-- Lista de usuarios -->

        <h2>Usuarios y sus Propiedades</h2>
        <div class="users-list-box">
          <div *ngIf="loading" class="loading">
            <ion-spinner></ion-spinner>
            <p>Cargando datos...</p>
          </div>

          <div
            *ngIf="!loading && filteredUsers.length === 0"
            class="empty-state"
          >
            <ion-icon name="people-outline" size="large"></ion-icon>
            <h3>No se encontraron resultados</h3>
            <p>Intenta con otros t√©rminos de b√∫squeda</p>
          </div>

          <ion-list
            *ngIf="!loading && filteredUsers.length > 0"
            class="user-list-scroll"
          >
            <ion-item-group *ngFor="let user of filteredUsers">
              <ion-item-divider
                color="light"
                (click)="toggleUserHouses(user.id)"
              >
                <ion-label>
                  <h2>{{ user.name }}</h2>
                  <p>
                    {{ user.email }} ‚Ä¢ {{ user.houses.length }} propiedad(es)
                  </p>
                </ion-label>
                <ion-button fill="clear" slot="end">
                  <ion-icon
                    [name]="user.showHouses ? 'chevron-up-outline' : 'chevron-down-outline'"
                  >
                  </ion-icon>
                </ion-button>
              </ion-item-divider>

              <div *ngIf="user.showHouses" class="houses-container">
                <ion-item-sliding
                  *ngFor="let house of user.houses"
                  class="house-item"
                >
                  <ion-item>
                    <ion-icon
                      name="home"
                      slot="start"
                      [color]="house.active ? 'success' : 'medium'"
                    ></ion-icon>
                    <ion-label>
                      <h3>{{ house.number }}</h3>
                      <p>Estado: {{ house.active ? 'Activa' : 'Inactiva' }}</p>
                    </ion-label>
                    <ion-badge
                      [color]="house.active ? 'success' : 'medium'"
                      slot="end"
                    >
                      {{ house.active ? 'Activa' : 'Inactiva' }}
                    </ion-badge>
                  </ion-item>

                  <ion-item-options side="end">
                    <ion-item-option
                      color="primary"
                      (click)="openEditHouse(house, user.id)"
                    >
                      <ion-icon slot="icon-only" name="create"></ion-icon>
                    </ion-item-option>

                    <ion-item-option
                      color="danger"
                      (click)="deleteHouse(house.id, user.id)"
                    >
                      <ion-icon slot="icon-only" name="trash"></ion-icon>
                    </ion-item-option>
                  </ion-item-options>
                </ion-item-sliding>
              </div>
            </ion-item-group>
          </ion-list>
        </div>
      </div>

      <!-- üí¨ Secci√≥n: Mensajes -->
      <div
        *ngIf="selectedSection === 'messages'"
        class="content-wrapper chat-wrapper"
      >
        <h1 class="section-title">Mensajes</h1>

        <div class="chat-layout">
          <!-- Lista de usuarios con mensajes -->
          <div class="chat-users">
            <h3>Conversaciones</h3>

            <!-- Estado vac√≠o -->
            <div *ngIf="messageUsers.length === 0" class="empty-state">
              <ion-icon name="chatbubble-outline" size="large"></ion-icon>
              <h3>No hay mensajes</h3>
              <p>
                Los mensajes aparecer√°n aqu√≠ cuando los usuarios te contacten
              </p>
            </div>

            <!-- Lista de usuarios -->
            <ion-list *ngIf="messageUsers.length > 0">
              <ion-item
                button
                *ngFor="let user of messageUsers"
                (click)="openChat(user)"
                [class.selected]="selectedChatUser?.id === user.id"
                detail="false"
              >
                <ion-label>
                  <h3>{{ user.name || 'Usuario' }}</h3>
                  <p>{{ user.email }}</p>
                  <p class="last-message" *ngIf="user.lastMessage">
                    {{ (user.lastMessage.length > 30) ? (user.lastMessage |
                    slice:0:30) + '...' : user.lastMessage }}
                  </p>
                  <small *ngIf="user.timestamp"
                    >{{ user.timestamp | date:'MMM d, h:mm a' }}</small
                  >
                </ion-label>
                <ion-badge *ngIf="user.unread" color="danger" slot="end">
                  {{ user.unreadCount || '' }}
                </ion-badge>
              </ion-item>
            </ion-list>
          </div>

          <!-- Ventana de chat -->
          <div class="chat-window" *ngIf="selectedChatUser">
            <div class="chat-header">
              <ion-button
                fill="clear"
                (click)="closeChat()"
                class="back-button"
              >
                <ion-icon name="arrow-back" slot="icon-only"></ion-icon>
              </ion-button>
              <div class="chat-user-info">
                <div>
                  <h3>{{ selectedChatUser.name || 'Usuario' }}</h3>
                  <p>{{ selectedChatUser.email }}</p>
                </div>
              </div>
            </div>

            <!-- √Årea de mensajes -->
            <div class="chat-messages" #messageContainer>
              <div
                *ngIf="(messages$ | async)?.length === 0"
                class="no-messages"
              >
                <p>No hay mensajes en esta conversaci√≥n</p>
                <p>Env√≠a el primer mensaje</p>
              </div>

              <div
                *ngFor="let msg of messages$ | async"
                [ngClass]="{
            'my-message': msg.fromUid === currentUid,
            'other-message': msg.fromUid !== currentUid
          }"
                class="message-bubble"
              >
                <p class="message-text">{{ msg.message }}</p>
                <small class="message-time">
                  {{ msg.timestamp?.toDate ? (msg.timestamp.toDate() |
                  date:'shortTime') : (msg.timestamp | date:'shortTime') }}
                </small>
              </div>
            </div>

            <!-- Input para enviar mensajes -->
            <div class="chat-input">
              <ion-input
                [(ngModel)]="newMessage"
                placeholder="Escribe un mensaje..."
                (keyup.enter)="sendMessage()"
                class="message-input"
              ></ion-input>
              <ion-button
                (click)="sendMessage()"
                color="primary"
                [disabled]="!newMessage.trim()"
                class="send-button"
              >
                <ion-icon name="send" slot="icon-only"></ion-icon>
              </ion-button>
            </div>
          </div>

          <!-- Placeholder cuando no hay chat seleccionado -->
          <div
            *ngIf="!selectedChatUser && messageUsers.length > 0"
            class="chat-placeholder"
          >
            <ion-icon
              name="chatbubble-ellipses-outline"
              size="large"
            ></ion-icon>
            <h3>Selecciona una conversaci√≥n</h3>
            <p>Elige un usuario de la lista para ver los mensajes</p>
          </div>
        </div>
      </div>

<!-- üü¶ SECCI√ìN: TICKETS -->
<div *ngIf="selectedSection === 'tickets'" class="content-wrapper">
  <h1 class="section-title">Tickets</h1>

  <!-- =======================
        PASO 1 ‚Äî LISTA DE CASAS
     ======================= -->
  <div *ngIf="ticketView === 'houses'">
    <ion-list>
      <ion-item
        button
        *ngFor="let h of housesForTickets"
        (click)="openHouseTickets(h)"
      >
        <ion-icon name="home-outline" slot="start"></ion-icon>
        <ion-label>
          <h2>Casa {{ h.number }}</h2>
          <p>Propietario: {{ h.owner }}</p>
        </ion-label>
        <ion-icon name="arrow-forward-circle-outline" slot="end"></ion-icon>
      </ion-item>
    </ion-list>
  </div>

  <!-- =======================
        PASO 2 ‚Äî LISTA TICKETS
     ======================= -->
  <div *ngIf="ticketView === 'tickets'">

    <ion-button fill="clear" (click)="ticketView = 'houses'">
      <ion-icon name="arrow-back"></ion-icon>
      Regresar
    </ion-button>

    <!-- FILTROS: ABIERTOS - CERRADOS -->
    <div class="ticket-filters">
      <button
        class="filter-btn"
        [class.active]="ticketStatus === 'abierto'"
        (click)="changeTicketStatus('abierto')"
      >
        Abiertos
      </button>

      <button
        class="filter-btn"
        [class.active]="ticketStatus === 'cerrado'"
        (click)="changeTicketStatus('cerrado')"
      >
        Cerrados
      </button>
    </div>

    <!-- BOT√ìN NUEVO TICKET -->
    <ion-button
      color="success"
      class="add-ticket-btn"
      (click)="openNewTicket()"
    >
      <ion-icon name="add" slot="start"></ion-icon>
      Nuevo Ticket
    </ion-button>

    <!-- LISTA DE TICKETS -->
    <ion-list class="tickets-list">
      <ion-item *ngFor="let t of tickets">
        <ion-label>
          <h2>{{ t.area }}</h2>
          <p>{{ t.descripcion }}</p>
          <small>{{ t.createdAt?.toDate() | date: 'medium' }}</small>
        </ion-label>

        <ion-badge
          [color]="t.status === 'abierto' ? 'warning' : 'success'"
        >
          {{ t.status }}
        </ion-badge>
      </ion-item>
    </ion-list>
  </div>

  <!-- =======================
        PASO 3 ‚Äî NUEVO TICKET
     ======================= -->
  <div *ngIf="ticketView === 'newTicket'" class="new-ticket-box">
    <ion-button fill="clear" color="medium" (click)="ticketView = 'tickets'">
      <ion-icon name="arrow-back" slot="start"></ion-icon>
      Cancelar
    </ion-button>

    <ion-item class="ticket-input">
      <ion-label>√Årea</ion-label>
      <ion-select [(ngModel)]="newTicket.area">
        <ion-select-option value="T√©cnica">T√©cnica</ion-select-option>
        <ion-select-option value="Atencion-a-clientes">Atencion a clientes</ion-select-option>
      </ion-select>
    </ion-item>

    <ion-item class="ticket-input">
      <ion-label position="floating">Descripci√≥n</ion-label>
      <ion-textarea [(ngModel)]="newTicket.descripcion"></ion-textarea>
    </ion-item>

    <ion-button
      expand="block"
      color="success"
      class="save-ticket-btn"
      (click)="saveTicket()"
    >
      Guardar Ticket
    </ion-button>
  </div>
</div>






    </div>
  </div>
</ion-content>
